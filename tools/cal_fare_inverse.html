<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>公路客運票價試算 反向</title>
</head>
<body>
<script type="text/javascript">
//除法函數，用來得到精確的除法結果
// 說明：javascript的除法結果會有誤差，在兩個浮點數相除的時候會比較明顯。這個函數返回較為精確的除法結果。
//調用：accDiv(arg1,arg2)
//返回值：arg1除以arg2的精確結果
function accDiv(arg1, arg2) {
         var t1 = 0, t2 = 0, r1, r2;
         try { t1 = arg1.toString().split(".")[1].length } catch (e) { }
         try { t2 = arg2.toString().split(".")[1].length } catch (e) { }
         with (Math) {
             r1 = Number(arg1.toString().replace(".", ""))
             r2 = Number(arg2.toString().replace(".", ""))
             return (r1 / r2) * pow(10, t2 - t1);
         }
     }

//給Number類型增加一個div方法，調用起來更加方便。
Number.prototype.div = function(arg) {
         return accDiv(this, arg);
     }

//乘法函數，用來得到精確的乘法結果
//說明：javascript的乘法結果會有誤差，在兩個浮點數相乘的時候會比較明顯。這個函數返回較為精確的乘法結果。
//調用：accMul(arg1,arg2)
//返回值：arg1乘以 arg2的精確結果
function accMul(arg1, arg2) {
         var m = 0, s1 = arg1.toString(), s2 = arg2.toString();
         try { m += s1.split(".")[1].length } catch (e) { }
         try { m += s2.split(".")[1].length } catch (e) { }
         return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m)
     }

// 給Number類型增加一個mul方法，調用起來更加方便。
Number.prototype.mul = function(arg) {
         return accMul(arg, this);
     }

//加法函數，用來得到精確的加法結果
//說明：javascript的加法結果會有誤差，在兩個浮點數相加的時候會比較明顯。這個函數返回較為精確的加法結果。
//調用：accAdd(arg1,arg2)
// 返回值：arg1加上arg2的精確結果
function accAdd(arg1, arg2) {
         var r1, r2, m, c;
         try { r1 = arg1.toString().split(".")[1].length } catch (e) { r1 = 0 }
         try { r2 = arg2.toString().split(".")[1].length } catch (e) { r2 = 0 }
         c = Math.abs(r1 - r2);
         m = Math.pow(10, Math.max(r1, r2))
         if (c > 0) {
             var cm = Math.pow(10, c);
             if (r1 > r2) {
                 arg1 = Number(arg1.toString().replace(".", ""));
                 arg2 = Number(arg2.toString().replace(".", "")) * cm;
             }
             else {
                 arg1 = Number(arg1.toString().replace(".", "")) * cm;
                 arg2 = Number(arg2.toString().replace(".", ""));
             }
         }
         else {
             arg1 = Number(arg1.toString().replace(".", ""));
             arg2 = Number(arg2.toString().replace(".", ""));
         }
         return (arg1 + arg2) / m
     }

//給Number類型增加一個add方法，調用起來更加方便。
Number.prototype.add = function(arg) {
         return accAdd(arg, this);
     }
//減法函數，用來得到精確的減法結果
//說明：javascript的減法結果會有誤差，在兩個浮點數相減的時候會比較明顯。這個函數返回較為精確的減法結果。
//調用：accSub(arg1,arg2)
// 返回值：arg1加上arg2的精確結果
function accSub(arg1,arg2){
　　 var r1,r2,m,n;
　　 try{r1=arg1.toString().split(".")[1].length}catch(e){r1=0}
　　 try{r2=arg2.toString().split(".")[1].length}catch(e){r2=0}
　　 m=Math.pow(10,Math.max(r1,r2));
　　 //last modify by deeka
　　 //動態控制精度長度
　　 n=(r1>=r2)?r1:r2;
　　 return ((arg1*m-arg2*m)/m).toFixed(n);
}
Number.prototype.sub = function(arg) {
         return accSub(arg, this);
     }
function cal_fare(fare_per_km, fare_per_km_card, interval_name, interval_dis){
	var base_dis = 8;
	var base_cash = Math.round(base_dis.mul(fare_per_km.mul(1.05)));
	var base_cash_card = Math.round(base_dis.mul(fare_per_km_card.mul(1.05)));
	var d_arr = [];
	//document.write('<table border="1">');
	for(var i=0;i<interval_name.length;++i){
		d_arr[i] = [];
		document.write('[');
		//document.write('<tr>');
		var sum = 0;
		for(j=0;j<interval_name.length;++j){
			//document.write('<td>');
			if(i==j){
				//document.write(interval_name[j]);
				document.write(base_cash);
				d_arr[i][j-i] = sum;
			}
			else if(i<j){
				sum = sum.add(interval_dis[j-1]);
				d_arr[i][j-i] = sum;
				//document.write(d_arr[i][j-i]);
				raw_cash = Math.round(d_arr[i][j-i].mul(fare_per_km_card.mul(1.05)));
				document.write(',');
				document.write( (raw_cash<base_cash_card)?base_cash_card:raw_cash );
			}
			else{
				raw_cash = Math.round(d_arr[j][i-j].mul(fare_per_km.mul(1.05)));
				//document.write(j+','+(i-j)+'='+d_arr[j][i-j]);
				document.write( (raw_cash<base_cash)?base_cash:raw_cash );
				document.write(',');
			}
			//document.write('</td>');
		}
			document.write('],<br />');
		//document.write('</tr>');
	}
}
	var fare_per_km = 2.892;
	var fare_per_km_old = 2.892;
	var interval_name = ["新營","茄苳腳","鹽水","牛稠仔","義竹<br />社區","義竹","頭竹圍","新富村","過路仔","竿仔寮","新塭","南鯤鯓","好美里"];
	var interval_price = [
	[24,22,22,22,22,23,31,34,39,43,49,1,1],
[24,24,22,22,22,22,25,28,32,36,42,1,1],
[24,24,24,22,22,22,22,23,28,32,37,1,1],
[28,24,24,24,22,22,22,22,23,28,33,1,1],
[32,24,24,24,24,22,22,22,22,22,26,1,1],
[34,24,24,24,24,24,22,22,22,22,25,1,1],
[39,24,24,24,24,24,24,22,22,22,22,1,1],
[44,29,24,24,24,24,24,24,22,22,22,1,1],
[53,38,29,25,24,24,24,24,24,22,22,1,1],
[60,45,36,32,28,26,24,24,24,24,22,1,1],
[71,56,47,43,39,37,32,26,24,24,24,1,1],
[86,71,62,58,54,52,47,41,33,26,24,24,1],
[80,65,56,52,48,46,41,36,27,24,24,24,24]
	];
	var interval_dis = [];
	var base_dis = 8;
	var base_cash = Math.round(base_dis.mul(fare_per_km.mul(1.05)));
	var base_cash_old = Math.round(base_dis.mul(fare_per_km_old.mul(1.05)));
	document.write('<table border="1">');
	for(i=0;i<interval_price.length;++i){
		interval_dis[i] = [];
		document.write('<tr>');
		//interval_dis[i] = interval_price[i+1][i];
		tmp_dis = 0;
		for(j=0;j<interval_price[i].length;++j){
			document.write('<td>');
			if(i==j) document.write(interval_name[j]);
			else if(i>j && interval_price[i][j]==base_cash_old){
				tmp_dis = 8;
				interval_dis[i].push( base_dis );
				document.write(base_dis);
			}
			else if(i>j){
				tmp_dis = interval_price[i][j].div(fare_per_km_old.mul(1.05)).toFixed(6);
				interval_dis[i].push( tmp_dis );
				document.write( tmp_dis );
			}
			else document.write(interval_price[i][j]);
			document.write('</td>');
		}
		document.write('</tr>');
	}
	document.write('</table><br />');
	document.write('<table border="1">');
	var accumulate = 0, acc_count=0;
	var card_fare_per_km = 2.540;//accMul(fare_per_km,0.87842);
	var real_dis = [];
	var count = 0, tmp_acc = 0;
	for(i=interval_dis.length-1;i>0;--i){
		count = 0;
		tmp_acc = 0;
		x = i;
		for(j=0;j<interval_price.length-2;++j){
			//document.write('('+i+','+j+')='+interval_dis[i][j] + '<>');
			//document.write(interval_dis[i][j]-interval_dis[i-1][j] + ' ');
			if(i-j==1){
				document.write('!!('+i+','+j+'); ');
				if(interval_dis[i][j]>base_dis){
					document.write('~~~');
					++count;
					tmp_acc = accAdd(tmp_acc, interval_dis[i][j]);
				}
			}
			if(i-j<=1){
				++x;
				document.write('~('+x+','+(i-1)+')-'+'('+x+','+i+'); ');
				if(interval_dis[x][i-1]!=base_dis && interval_dis[x][i]!=base_dis){
					document.write('~~~');
					++count;
					tmp_acc = accAdd(tmp_acc, accSub(interval_dis[x][i-1], interval_dis[x][i]));
				}
			}
			else{
				document.write('('+i+','+j+')-'+'('+(i-1)+','+j+'); ');
				if(interval_dis[i-1][j]!=base_dis && interval_dis[i][j]!=base_dis){
					document.write('~~~');
					++count;
					tmp_acc = accAdd(tmp_acc, accSub(interval_dis[i][j], interval_dis[i-1][j]));
				}
			}
		}
		real_dis[i-1] = accDiv(tmp_acc, count);
		document.write(real_dis[i-1]+'::'+count+'<br />');
	}
	document.write(real_dis+'<br />');
	cal_fare(fare_per_km,card_fare_per_km,interval_name,real_dis);
	for(i=0;i<interval_price.length;++i){
		document.write('<tr>');
		//interval_dis[i] = interval_price[i+1][i];
		//accumulate_row = 0;
		//row_count = 0;
		for(j=0;j<interval_price[i].length;++j){
			document.write('<td>');
			if(i==j) document.write(interval_name[j]);
			else if(i<j){
				document.write( Math.round( accMul(interval_dis[j][i],accMul(card_fare_per_km,1.05) ) ) );
				//document.write(accMul(interval_price[j][i],0.87842));
				//tmp_dis = interval_dis[j][i];
				//interval_price[i][j].div(interval_dis[j][i].mul(1.05)).toFixed(1);
				//interval_dis[i].push( tmp_dis );
				/*document.write(accDiv(interval_price[i][j], accMul(tmp_dis,1.05) ));
				if(	interval_price[i][j]==22) continue;
				++row_count;
				accumulate_row = accAdd(accumulate_row, accDiv(interval_price[i][j], accMul(tmp_dis,1.05) ) );
				++acc_count;
				accumulate = accAdd(accumulate, accDiv(interval_price[i][j], accMul(tmp_dis,1.05) ) );*/
			}
			else{
				document.write( Math.round( accMul(interval_dis[i][j],accMul(fare_per_km,1.05) ) ) );
			}
			document.write('</td>');
		}
		//tmp_row = accDiv(accumulate_row,row_count);
		document.write('</tr>');//<br />aver_fare_ration='+tmp_row);
		//if()
	}
		//tmp = accDiv(accumulate,acc_count);
	document.write('</table>');//<br />aver_fare_ration='+tmp);
</script>
</body>
</html>