/*! TainanBusMap 2015-01-23 */
function CreateBusMap(a){RouteDownloadManager=new L.TainanBus.RenderManager,map=L.map("map").setView([23.1852,120.4287],11),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:MapAttribution}).addTo(map),-1===a.search(",")?GetRouteByCode(a,!1):GetRouteByCode(a,!0)}function GetRouteByCode(a,b){$.getJSON(categoryJsonUrl+routeJsonExtension,function(c){if($.each(c,function(a,b){RouteDownloadManager.InitStopIconOption(b.categoryIndex);var c={MainLineColor:b.categoryLineColor,ExtendLineColor:b.categoryLineColor2};ColorSchemeCollect.push(c)}),b===!0)var d=a.split(",");else{var d=[];d.push(a)}$.getJSON(AllRoutesJsonUrl+routeJsonExtension,function(a){for(var c=0;c<d.length;++c)$.each(a,function(a,b){if(d[c]==b.RouteCodeName){var e={Category:b.RouteCategory,RelationID:b.RouteOSMRelation,Name:b.RouteName,Code:b.RouteCodeName};return RouteElements.push(e),!1}});d.length!==RouteElements.length?window.alert("編號有誤!"):(map.addControl(new L.BusSelectRouteControl(RouteElements)),void 0===DirControl&&(DirControl=new L.BusDirControl,map.addControl(DirControl)),b===!1&&($(".selRoute").css("visibility","hidden"),$("#selr").css("visibility","hidden")),SetSelectRoute(),$("#selr").change(function(){SetSelectRoute()}),$('input[name="direction"]:radio').change(function(){SetSelectDir()}))})})}function SetSelectRoute(){var a=$("#selr option:selected").attr("value"),b=a.split(",");currentScheme=ColorSchemeCollect[b[0]-1],RouteDownloadManager.InitLeafletOption(b[0],currentScheme),void 0!==DirControl&&(DirControl.RefreshRelationID(b[1],b[2]),DirControl.ToggleVisible("0L"===b[2]||"0R"===b[2]||"city_bus_0"===b[2]?!1:!0)),SetSelectDir()}function SetSelectDir(){var a=$('input[name="direction"]:checked').val();"0L"===DirControl._busRelationCode||"0R"===DirControl._busRelationCode||"city_bus_0"===DirControl._busRelationCode?RouteDownloadManager.DownloadRouteMaster(DirControl._busRelationID,!0,DivString):"forward"==a?RouteDownloadManager.DownloadRouteMaster(DirControl._busRelationID,!0,DivString):RouteDownloadManager.DownloadRouteMaster(DirControl._busRelationID,!1,DivString)}var AllRoutesJsonUrl="LocalData/AllBusRoutes",RouteDownloadManager,DivString="#map",DirControl,ColorSchemeCollect=[],RouteElements=[];$(document).ready(function(){var a=$(DivString);return void 0===a||void 0===a.attr("bus-ref")?void window.alert("找不到地圖Div或編號不存在!"):void CreateBusMap(a.attr("bus-ref"))}),L.BusDirControl=L.Control.extend({options:{position:"topright"},initialize:function(a){L.Util.setOptions(this,a),this._busRelationID=0,this._busRelationCode=""},onAdd:function(){var a='<input type="radio" name="direction" value="forward" checked>往程<br/>',b='<input type="radio" name="direction" value="backward">返程',c=L.DomUtil.create("div","dir");return $(c).append(a,b),c},onRemove:function(){},RefreshRelationID:function(a,b){this._busRelationID=a,this._busRelationCode=b},ToggleVisible:function(a){var b=$(".dir");void 0!==b&&(a===!0?b.css("visibility","visible"):a===!1&&b.css("visibility","hidden"))}}),L.BusSelectRouteControl=L.Control.extend({options:{position:"topleft"},initialize:function(a,b){L.Util.setOptions(this,b),this._RouteElements=a},onAdd:function(){for(var a='<select id="selr">',b="</select>",c="",d=0;d<this._RouteElements.length;d++){var e='<option label="'+this._RouteElements[d].Name+'" value="'+this._RouteElements[d].Category+","+this._RouteElements[d].RelationID+","+this._RouteElements[d].Code+'">'+this._RouteElements[d].Name+"</option>";c+=e}var f=L.DomUtil.create("div","selRoute");return $(f).append(a+c+b),f},onRemove:function(){}});