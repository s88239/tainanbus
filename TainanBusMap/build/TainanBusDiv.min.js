/*! TainanBusMap 2015-09-07 */
function CreateBusMap(a){RouteDownloadManager=new L.TainanBus.RenderManager,map=L.map("map").setView([23.1852,120.4287],11),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:MapAttribution}).addTo(map),-1===a.search(",")?GetRouteByCode(a,"NoMulti"):GetRouteByCode(a,"Multi")}function GetRouteByCode(a,b){$.getJSON(categoryJsonUrl+routeJsonExtension,function(c){if($.each(c,function(a,b){RouteDownloadManager.InitStopIconOption(b.categoryIndex);var c={MainLineColor:b.categoryLineColor,ExtendLineColor:b.categoryLineColor2};ColorSchemeCollect.push(c)}),"Multi"===b)var d=a.split(",");else{var d=[];d.push(a)}$.getJSON(AllRoutesJsonUrl+routeJsonExtension,function(a){for(var c=0;c<d.length;++c)$.each(a,function(a,b){if(d[c]==b.RouteCodeName){var e={Category:b.RouteCategory,RelationID:b.RouteOSMRelation,Name:b.RouteName,Code:b.RouteCodeName,CodeNum:b.RouteCode,OneWay:void 0!==b.OneWayRoute};return RouteElements.push(e),!1}});d.length!==RouteElements.length?window.alert("編號有誤!"):(map.addControl(new L.BusSelectRouteControl(RouteElements)),void 0===DirControl&&(DirControl=new L.BusDirControl,map.addControl(DirControl)),void 0===InfoControl&&(InfoControl=new L.BusInfoControl,map.addControl(InfoControl)),"NoMulti"===b&&($(".selRoute").css("visibility","hidden"),$("#selr").css("visibility","hidden")),SetSelectRoute(),$("#selr").change(function(){SetSelectRoute()}),$('input[name="direction"]:radio').change(function(){SetSelectDir()}))})})}function SetSelectRoute(){var a=$("#selr option:selected").attr("value"),b=a.split(",");currentScheme=ColorSchemeCollect[b[0]-1],RouteDownloadManager.InitLeafletOption(b[0],currentScheme),void 0!==DirControl&&(DirControl.RefreshRelationID(b[1]),"true"===b[3]?DirControl.ToggleVisible(!1):DirControl.ToggleVisible(!0)),void 0!==InfoControl&&InfoControl.RefreshRelationCode(b[4]),SetSelectDir()}function SetSelectDir(){var a=$('input[name="direction"]:checked').val();RouteDownloadManager.DownloadRouteMaster(DirControl._busRelationID,a,DivString)}function QueryRealtimeBus(){var a=$("#codeID").text();window.open(RealtimeBusURL+a,a)}var AllRoutesJsonUrl="LocalData/AllBusRoutes",RouteDownloadManager,DivString="#map",DirControl,InfoControl,ColorSchemeCollect=[],RouteElements=[];$(document).ready(function(){var a=$(DivString);return void 0===a||void 0===a.attr("bus-ref")?void window.alert("找不到地圖Div或編號不存在!"):void CreateBusMap(a.attr("bus-ref"))}),L.BusInfoControl=L.Control.extend({options:{position:"bottomleft"},initialize:function(a){L.Util.setOptions(this,a),this._busRelationCode=0},onAdd:function(a){var b=L.DomUtil.create("div","info");return $(b).html('<a id="rLink" href="#">路線資訊</a>'),b},onRemove:function(a){},RefreshRelationCode:function(a){this._busRelationCode=a,$("#rLink").html('<a id="rLink" href="'+routeInfoUrl+this._busRelationCode+'" target="_blank">路線資訊</a>')}}),L.BusDirControl=L.Control.extend({options:{position:"topright"},initialize:function(a){L.Util.setOptions(this,a),this._busRelationID=0},onAdd:function(a){var b='<input type="radio" name="direction" value="forward" checked>往程<br/>',c='<input type="radio" name="direction" value="backward">返程',d=L.DomUtil.create("div","dir");return $(d).append(b,c),d},onRemove:function(a){},RefreshRelationID:function(a){this._busRelationID=a},ToggleVisible:function(a){var b=$(".dir");void 0!==b&&(a===!0?b.css("visibility","visible"):a===!1&&b.css("visibility","hidden"))}}),L.BusSelectRouteControl=L.Control.extend({options:{position:"topleft"},initialize:function(a,b){L.Util.setOptions(this,b),this._RouteElements=a},onAdd:function(a){for(var b='<select id="selr">',c="</select>",d="",e=0;e<this._RouteElements.length;e++){var f='<option label="'+this._RouteElements[e].Name+'" value="'+this._RouteElements[e].Category+","+this._RouteElements[e].RelationID+","+this._RouteElements[e].Code+","+this._RouteElements[e].OneWay+","+this._RouteElements[e].CodeNum+'">'+this._RouteElements[e].Name+"</option>";d+=f}var g=L.DomUtil.create("div","selRoute");return $(g).append(b+d+c),g},onRemove:function(a){}});