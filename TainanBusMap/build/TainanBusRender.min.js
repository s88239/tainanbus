/*! TainanBusMap 2014-11-25 */
L.TainanBus={};var OSMAPIUrl="http://api.openstreetmap.org/api/0.6/relation/",FullQuery="/full",BusIcon="Icons/busIcon",BusIcon_Ext=".png",Button_Set='<button type="button" class="btn btn-default btn-sm" onclick="QueryRealtimeBus(',Button_Set2=');"><span class="glyphicon glyphicon-search" aria-hidden="true"></span>經過路線/動態</span></button>';L.TainanBus.IconTemplate=L.Icon.extend({options:{iconSize:[20,20],iconAnchor:[10,10]}}),L.TainanBus.RenderManager=L.Class.extend({initialize:function(){this._RouteLayers=[],this._BusMainRouteLineOptions={},this._BusExtendRouteLineOptions={},this._BusIconOptions=[],this._currentBusMarker=null},InitStopIconOption:function(a){var b=new L.TainanBus.IconTemplate({iconUrl:BusIcon+a+BusIcon_Ext});this._BusIconOptions.push(b)},InitLeafletOption:function(a,b){this._currentBusMarker=this._BusIconOptions[a-1],this._BusMainRouteLineOptions={color:b.MainLineColor,opacity:1,clickable:!1},this._BusExtendRouteLineOptions={color:b.ExtendLineColor,opacity:1,clickable:!1}},DownloadRouteMaster:function(a,b,c){if(this._RouteLayers.length>0)for(var d=0;d<this._RouteLayers.length;d++)this._RouteLayers[d].clearLayers();var e=this;$.ajax({url:OSMAPIUrl+a,dataType:"xml",success:function(a){var d=new L.TainanBus.getRoutesInMaster(a),f=0;e.BlockingMask(!0,c);for(var g=0;g<d.length;g++)d[g].Direction===b&&(e.RenderRoute(d[g].Ref,d[g].Extend,function(a){e._RouteLayers.push(a)}),f++);0==f&&(void 0===bootbox?window.alert("此路線為單向行駛!"):bootbox.alert("此路線為單向行駛!")),window.setTimeout(function(){e.BlockingMask(!1,c)},2e3)},error:function(){void 0===bootbox?window.alert("資料載入失敗!"):bootbox.alert("資料載入失敗!"),window.setTimeout(function(){e.BlockingMask(!1,c)},2e3)}})},RenderRoute:function(a,b,c){var d=this;$.ajax({url:OSMAPIUrl+a+FullQuery,dataType:"xml",success:function(a){layer=new L.TainanBus.DataLayer(a,b,d).addTo(map),b===!1&&map.fitBounds(layer.getBounds()),null!==c&&c(layer)},error:function(){void 0===bootbox?window.alert("資料載入失敗!"):bootbox.alert("資料載入失敗!")}})},BlockingMask:function(a,b){a===!0?void 0==b||null==b?$.blockUI({message:"<h1>載入中...</h1>",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px",opacity:.5,color:"#fff"}}):$(b).block({message:"<h1>載入中...</h1>",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px",opacity:.5,color:"#fff"}}):null==b||void 0==b?$.unblockUI():$(b).unblock()}}),L.TainanBus.DataLayer=L.FeatureGroup.extend({options:{uninterestingTags:["source","source_ref","source:ref","history","attribution","created_by","tiger:county","tiger:tlid","tiger:upload_uuid"],styles:{}},initialize:function(a,b,c,d){L.Util.setOptions(this,d),L.FeatureGroup.prototype.initialize.call(this),a&&this.addData(a,b,c)},addData:function(a,b,c){var d={showCoverageOnHover:!1,maxClusterRadius:20},e=new L.MarkerClusterGroup(d);a instanceof Array||(a=this.buildFeatures(a));for(var f=0;f<a.length;f++){var g,h=a[f];if("node"===h.type){if(this.CheckEnableBusStop()){var i={icon:c._currentBusMarker,opacity:1,zIndexOffset:1e3,riseOnHover:!0,title:this.GetBusStopName(h.tags)};e.addLayer(L.marker(h.latLng,i).bindPopup("<h5>"+this.GetBusStopName(h.tags)+"</h5><br>站牌代碼：<b>"+this.GetBusStopCode(h.tags)+"</b><br>"+Button_Set+this.GetBusStopCode(h.tags)+Button_Set2))}}else{for(var j=new Array(h.nodes.length),k=0;k<h.nodes.length;k++)j[k]=h.nodes[k].latLng;g=0==b?L.polyline(j,c._BusMainRouteLineOptions):L.polyline(j,c._BusExtendRouteLineOptions)}void 0!==g&&(g.addTo(this),g.feature=h)}void 0!==e&&e.addTo(this)},buildFeatures:function(a){{var b=[],c=L.TainanBus.getNodes(a),d=L.TainanBus.getWays(a,c);L.TainanBus.getRelations(a,c,d)}for(var e in c){var f=c[e];this.isBusStop(f)&&b.push(f)}for(var g=0;g<d.length;g++){var h=d[g];b.push(h)}return b},isBusStop:function(a){var b=!1;for(var c in a.tags)if("bus_stop"==a.tags[c]){b=!0;break}return b},CheckEnableBusStop:function(){var a=!1,b=$("#ShowBusStop:checked"),c=$("#ShowBusStop");return(b.length>0||0==c.length)&&(a=!0),a},GetBusStopName:function(a){var b="";for(var c in a)if("name"==c){b=a[c];break}return b},GetBusStopCode:function(a){var b=0;for(var c in a)if("ref"==c){b=a[c];break}return b}}),L.Util.extend(L.TainanBus,{getNodes:function(a){for(var b={},c=a.getElementsByTagName("node"),d=0;d<c.length;d++){var e=c[d],f=e.getAttribute("id");b[f]={id:f,type:"node",latLng:L.latLng(e.getAttribute("lat"),e.getAttribute("lon"),!0),tags:this.getTags(e)}}return b},getWays:function(a,b){for(var c=[],d=a.getElementsByTagName("way"),e=0;e<d.length;e++){for(var f=d[e],g=f.getElementsByTagName("nd"),h={id:f.getAttribute("id"),type:"way",nodes:new Array(g.length),tags:this.getTags(f)},i=0;i<g.length;i++)h.nodes[i]=b[g[i].getAttribute("ref")];c.push(h)}return c},getRoutesInMaster:function(a){for(var b=[],c=a.getElementsByTagName("relation"),d=0;d<c.length;d++)for(var e=c[d],f=e.getElementsByTagName("member"),g=0;g<f.length;g++)if("relation"===f[g].getAttribute("type")){var h=!1,i="forward";switch(f[g].getAttribute("role")){case"forward":i=!0,h=!1;break;case"backward":i=!1,h=!1;break;case"forward_extend":i=!0,h=!0;break;case"backward_extend":i=!1,h=!0}var j={Ref:f[g].getAttribute("ref"),Extend:h,Direction:i};b.push(j)}return b},getRelations:function(a,b){for(var c=[],d=a.getElementsByTagName("relation"),e=0;e<d.length;e++){for(var f=d[e],g=f.getElementsByTagName("member"),h={id:f.getAttribute("id"),type:"relation",members:new Array(g.length),tags:this.getTags(f)},i=0;i<g.length;i++)h.members[i]="node"===g[i].getAttribute("type")?b[g[i].getAttribute("ref")]:null;c.push(h)}return c},getTags:function(a){for(var b={},c=a.getElementsByTagName("tag"),d=0;d<c.length;d++)b[c[d].getAttribute("k")]=c[d].getAttribute("v");return b}});